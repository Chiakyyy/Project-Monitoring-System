<div class="container mt-4 mb-5">

    <div class="container mt-4 mb-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-check-circle-fill"></i> Validation des Marchés</h2>

            <button class="btn btn-outline-secondary" (click)="toggleFilters()" [class.active]="showFilters">
                <i class="bi bi-funnel-fill"></i> Filtrer
            </button>
        </div>

        <div *ngIf="showFilters" class="card bg-light mb-4 shadow-sm border-0">
            <div class="card-body">
                <div class="row g-3">

                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Statut</label>
                        <select class="form-select" [(ngModel)]="filters.status" (change)="applyFilters()">
                            <option value="">Tous les statuts</option>
                            <option value="PENDING">En Attente</option>
                            <option value="ACCEPTED">Validé</option>
                            <option value="INVALID">Invalide</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Budget Minimum (€)</label>
                        <input type="number" class="form-control" placeholder="Ex: 1000" [(ngModel)]="filters.minBudget"
                            (input)="applyFilters()">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Créé après le</label>
                        <div class="input-group">
                            <input type="date" class="form-control" [(ngModel)]="filters.date"
                                (change)="applyFilters()">
                            <button class="btn btn-secondary" (click)="resetFilters()" title="Réinitialiser">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="row g-4">

            <div class="col-12" *ngFor="let p of projects">
                <div class="card shadow-sm border-start border-4" [ngClass]="{
                'border-warning': p.status === 'PENDING',
                'border-success': p.status === 'ACCEPTED',
                'border-danger': p.status === 'INVALID'
            }">

                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-primary">{{ p.title }}</h5>
                        <span class="badge" [ngClass]="'bg-' + getStatusColor(p.status)">
                            {{ p.status }}
                        </span>
                    </div>

                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <p><strong>Objectif:</strong> {{ p.objective }}</p>

                                <div class="d-flex gap-4 mb-2">
                                    <div><i class="bi bi-cpu"></i> <strong>Matériel:</strong> {{ p.hardware_needs ||
                                        'Aucun'
                                        }}</div>
                                    <div><i class="bi bi-window"></i> <strong>Licences:</strong> {{ p.software_licenses
                                        ||
                                        'Aucune' }}</div>
                                </div>

                                <div class="mt-2" *ngIf="p.file_path">
                                    <a href="#" class="btn btn-sm btn-outline-secondary"
                                        (click)="$event.preventDefault()">
                                        <i class="bi bi-file-earmark-text"></i> Télécharger le CPS (.txt)
                                    </a>
                                </div>
                            </div>

                            <div class="col-md-4 text-end border-start">
                                <h4 class="text-success">{{ p.budget_estimated | currency:'EUR' }}</h4>
                                <small class="text-muted">Budget Estimé</small>

                                <div class="d-grid gap-2 mt-3" *ngIf="p.status === 'PENDING'">
                                    <button class="btn btn-success" (click)="updateStatus(p, 'ACCEPTED')">
                                        <i class="bi bi-check-lg"></i> Accepter
                                    </button>
                                    <button class="btn btn-danger" (click)="updateStatus(p, 'INVALID')">
                                        <i class="bi bi-x-lg"></i> Invalider
                                    </button>
                                </div>

                                <div class="mt-3 text-muted" *ngIf="p.status !== 'PENDING'">
                                    <em>Créer le {{ p.created_at | date }}</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="projects.length === 0" class="text-center text-muted mt-5">
                <i class="bi bi-inbox fs-1"></i>
                <p>Aucun projet à valider.</p>
            </div>

        </div>
    </div>